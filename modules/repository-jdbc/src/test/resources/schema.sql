/*
 * Copyright 2024 searchkim Inc. - All Rights Reserved.
 */

-- URL Shortener 테이블 생성 (H2용 - 대문자 테이블명 사용)

-- USERS 테이블
CREATE TABLE IF NOT EXISTS USERS (
    USER_ID BIGINT AUTO_INCREMENT PRIMARY KEY,
    EMAIL VARCHAR(255) NOT NULL UNIQUE,
    NAME VARCHAR(255) NOT NULL,
    CREATED_AT TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    UPDATED_AT TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- LINKS 테이블
CREATE TABLE IF NOT EXISTS LINKS (
    LINK_ID BIGINT AUTO_INCREMENT PRIMARY KEY,
    ORIGINAL_URL VARCHAR(2048) NOT NULL,
    SHORT_CODE VARCHAR(20) NOT NULL UNIQUE,
    USER_ID BIGINT,
    EXPIRES_AT TIMESTAMP,
    CREATED_AT TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    UPDATED_AT TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (USER_ID) REFERENCES USERS(USER_ID) ON DELETE SET NULL
);

-- SHORT_CODE 인덱스 (빠른 조회를 위해)
CREATE INDEX IF NOT EXISTS IDX_LINKS_SHORT_CODE ON LINKS(SHORT_CODE);
CREATE INDEX IF NOT EXISTS IDX_LINKS_USER_ID ON LINKS(USER_ID);

-- LINK_CLICKS 테이블
CREATE TABLE IF NOT EXISTS LINK_CLICKS (
    CLICK_ID BIGINT AUTO_INCREMENT PRIMARY KEY,
    LINK_ID BIGINT NOT NULL,
    CLICKED_AT TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    IP_ADDRESS VARCHAR(45),  -- IPv6 지원
    USER_AGENT VARCHAR(512),
    REFERER VARCHAR(2048),
    FOREIGN KEY (LINK_ID) REFERENCES LINKS(LINK_ID) ON DELETE CASCADE
);

-- LINK_ID 인덱스 (통계 조회 성능 향상)
CREATE INDEX IF NOT EXISTS IDX_LINK_CLICKS_LINK_ID ON LINK_CLICKS(LINK_ID);
CREATE INDEX IF NOT EXISTS IDX_LINK_CLICKS_CLICKED_AT ON LINK_CLICKS(CLICKED_AT);